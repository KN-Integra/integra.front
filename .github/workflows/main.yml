name: Preview Deployment

on:
  workflow_dispatch:

jobs:
  sync_submodules:
    name: 'Submodules Sync'
    runs-on: ubuntu-latest

    defaults:
      run:
        shell: bash

    steps:
    - name: Checkout
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.CI_TOKEN }}
        submodules: true
        fetch-depth: 0

  lint:
    name: 'Superlinter'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          # Full git history is needed to get a proper list of changed files within `super-linter`
          fetch-depth: 0

      - name: Lint Code Base
        uses: github/super-linter/slim@v4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DEFAULT_BRANCH: "main"
          VALIDATE_ALL_CODEBASE: false
          LINTER_RULES_PATH: "/"
          CSS_FILE_NAME: ".stylelintrc.yml"
          TYPESCRIPT_ES_CONFIG_FILE: ".eslintrc.yml"
          VALIDATE_TSX: true
          VALIDATE_TYPESCRIPT_ES: true
          VALIDATE_CSS: true

  security:
    name: Snyk Security
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
      - name: Snyk
        uses: snyk/actions@0.4.0
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: monitor

  vercel:
    name: Preview Deploy to Vercel
    runs-on: ubuntu-latest

    needs:
      - sync_submodules
      - lint
      - security

    steps:
      - uses: actions/checkout@v3
      - name: Install Vercel CLI
        run: npm install --global vercel@latest
      - name: Pull Vercel Environment Information
        run: vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}
      - name: Build Project Artifacts
        run: vercel build --token=${{ secrets.VERCEL_TOKEN }}
      - name: Deploy Project Artifacts to Vercel
        run: vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }}
